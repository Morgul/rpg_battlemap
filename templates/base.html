<!DOCTYPE html>
<html>
<head>
	<link type="text/css" href="/css/base.css" rel="stylesheet" />
	<link type="text/css" href="/contrib/css/smoothness/jquery-ui.css" rel="stylesheet" />
	<script type="text/javascript" src="/contrib/jquery.js"></script>
	<script type="text/javascript" src="/contrib/jquery-ui.min.js"></script>
	<script type="text/javascript" src="/contrib/jquery.tools.min.js"></script>
	{% block page_scripts %}
	<script type="text/javascript" src="/contrib/raphael-min.js"></script>
	<script type="text/javascript" src="/js/battlemap.js"></script>
	{% endblock %}
	<title>RPG Battle Map{% block title %}{% endblock %}</title>
	{% block page_style %}
	{% endblock %}
</head>
<body>
<div id="head">
<form id="login" action="/account/login/" method="post">
	<input name="openid" placeholder="{% trans "OpenID" %}" />
	<input type="submit" value="{% trans "Login" %}" />
</form>
</div>
<div id="main">
{% block content %}
	<div id="leftColumn">
		<h3><a href="#">Combatant</a></h3>
		<div id="combatantInfo">
			<div object-property="color" display-attr="style" style-display="border-color" style="float: left; width: 48px; height: 48px; border-width: 3px; margin:3px; border-style:solid;">
			<img object-property="image" display-attr="src" style="width:100%; height: 100%;" />
		</div>
			<p object-property="name">&nbsp;</p>
			<p>cell
				<span object-property="cellX">&nbsp;</span>, <span object-property="cellY">&nbsp;</span>
			</p>
			<p id="combatantConditions">&nbsp;</p>
		</div>
		<h3><a href="#">Turn Order</a></h3>
		<ul id="combatantList">
		</ul>
		<h3><a href="#">New Combatant</a></h3>
		<div id="addCombatant">
			<form name="addCombatant">
				<p>
					<input name="name" placeholder="Combatant Name" />
				</p>
				<p>
					<label>Starting Position</label>
					<input style="width: 4em;" name="cellX" placeholder="X" type="number" />,
					<input style="width: 4em;" name="cellY" placeholder="Y" type="number" /></p>
				<p>
					<label for="color">Color</label>
					<input name="color" placeholder="blue" type="color" />
				</p>
				<p>
					<label for="initiative">Initiative</label>
					<input name="initiative" placeholder="10" type="number" />
				</p>
				<p>
					<label for="size">Size</label>
					<input name="size" value="1" type="number" />
				</p>
				<p>
					<input name="create" type="submit" value="Add Combatant" />
				</p>
			</form>
		</div>
		<h3><a href="#">Zone Editor</a></h3>
		<div id="zoneEditor">
			<form name="zoneEditor">
				<p>
					<label for="editZonesToggle">Enabled Zone Edits</label>
					<input id="editZonesToggle" type="checkbox" />
				</p>
				<ul id="zoneList">
					<li>New Zone...</li>
				</ul>
				<p>
					<label>Top Left Corner</label>
					<input style="width: 4em;" name="cellX" placeholder="X" type="number" />, 
					<input style="width: 4em" name="cellY" placeholder="Y" type="number" />
				</p>
				<p>
					<label>Raw Cell Data</label>
					<textarea name="cellData"></textarea>
				</p>
				<p>While editing is enabled, you can add a new point connected to 
the most recent point by clicking.  To remove a point, secondary (right) 
click on it.  To add a point on an existing line, secondary click on the
line.  To move a point, drag it to the desired position.
				</p>
			</form>
		</div>
	</div>
	<div id="rightColumn" class="ui-corner-all">
		<div id="drawingBoard">
			<canvas id="canvasBoard"></canvas>
		</div>
	</div>
</div>
<script type="text/javascript">
	$().ready(function(){
		window.battleMap = new BattleMap('drawingBoard', 'canvasBoard', {});
		function resizeBattleMap() {
			var headerHeight = $('#head').height();
			var guessheight = window.innerHeight - (headerHeight + 20) ;
			$('#drawingBoard').height(guessheight);
			var newHeight = $('#drawingBoard').height();
			var newWidth = $('#drawingBoard').width();
			$('#canvasBoard').attr("width", newWidth)
			$('#canvasBoard').attr("height", newHeight);
			window.battleMap.drawGrid();
		}

		$(window).resize(resizeBattleMap);

		$('#drawingBoard').mousewheel(function(ev, delta){
			if(isNaN(delta)){
				delta = ev.originalEvent.wheelDelta;
			}
			delta = delta / 100;
			battleMap.setZoom(battleMap.zoom + delta);
			return false;
		});

		resizeBattleMap();
		window.battleMap.drawGrid();

		window.combatantList = [];

		window.updateCombatantListDisplay = function(){
			combatantList = combatantList.sort(Combatant.sortByInitiative);
			var cl = $('#combatantList');
			cl.empty();
			combatantList.map(function(dude, ind){
				cl.append('<li style="border-color:' + dude.color + '">' + dude.name + '</li>');
			});
		}

		$('#addCombatant form').submit(function(){
			var creationObj = {};
			var newCombatant;
			for(var i = 0; i < this.elements.length; i++){
				creationObj[this.elements[i].name] = this.elements[i].value;
			}
			creationObj.onMouseOver = function(){
				datadump(newCombatant, '#combatantInfo');
				$('#combatantConditions').html(newCombatant.conditions.join(", "));
			}
			newCombatant = new Combatant(window.battleMap, creationObj);
			combatantList.push(newCombatant);
			updateCombatantListDisplay();
			return false;
		});
		$('#leftColumn').height($('#drawingBoard').height()).accordion({
			autoHeight:false
		});
	});
</script>
{% endblock %}
</body>
