{% extends "base.html" %}

{% block title %} - {{ map.name }} {% endblock %}

{% block page_style %}
<link type="text/css" href="/contrib/css/smoothness/jquery-ui.css" rel="stylesheet" />
{% endblock %}
{% block content %}

<div id="toolbar"></div>

<script type="text/x-handlebars" data-template-name="map">
<svg
	xmlns="http://www.w3.org/2000/svg" version="1.1"
	{% templatetag openvariable %} bindStyle background-color="content.background_color" height="viewHeight"{% templatetag closevariable %}
	{% templatetag openvariable %}action "clicked" {% templatetag closevariable %}>
	{% templatetag openvariable %}action "didit" on="scroll"{% templatetag closevariable %}>
	<defs>
		<pattern x="0" y="0" width="512" height="512" id="gridPattern"
			patternUnits="userSpaceOnUse"
			{% templatetag openvariable %}bindXMLAttr patternTransform="transformString"{% templatetag closevariable %}>{% for patternInfo in pattern_helper %}
			<rect
				x="{{ patternInfo.x }}"
				y="{{ patternInfo.y }}"
				width="32" height="32" fill-opacity="0"
				{% templatetag openvariable %}bindAttr stroke="content.gridline_color"{% templatetag closevariable %}
				{% templatetag openvariable %} bindAttr stroke-width="content.gridline_width" {% templatetag closevariable %}
				{% templatetag openvariable %} bindAttr stroke-opacity="content.grid_opacity" {% templatetag closevariable %} />{% endfor %}
		</pattern>
	</defs>

	<rect x="0" y="0" width="100%" height="100%" stroke-opacity="0"
		fill="url(#gridPattern)" style="pointer-events:none;" id="gridRect"/>
</svg>
</script>

{% endblock %}

{% block page_scripts %}

<script type="text/javascript" src="/contrib/jquery.mousewheel.min.js"></script>
<!--<script type="text/javascript" src="/contrib/jquery-ui.min.js"></script>
<script type="text/javascript" src="/contrib/bullet.js"></script>
<script type="text/javascript" src="/contrib/handlebars-1.0.rc.1.js"></script>
<script type="text/javascript" src="/contrib/ember.js"></script>-->
<script type="text/javascript" src="/contrib/jquery-ui-1.9pre.js"></script>
<script type="text/javascript" src="/contrib/handlebars-1.0.0.beta.6.js"></script>
<script type="text/javascript" src="/contrib/ember-1.0.pre.js"></script>
<script type="text/javascript" src="/js/bind_extensions.js"></script>
<script type="text/javascript" src="/contrib/jquery-ember-bridge.js"></script>
<script type="text/javascript" src="/js/rpgb_core.js"></script>
<script type="text/javascript" src="/js/rpgb_gridPropertiesView.js"></script>
<script type="text/javascript" src="/js/rpgb_mapView.js"></script>
<script type="text/javascript" src="/js/rpgb_layer_views.js"></script>
<script id="mapJson" type="application/json">
{{ map_json }}
</script>
<script type="text/javascript">

/***
* code that does stuff
***/

RPGB.mapController = RPGB.RestObject.create({});
RPGB.layerController = Ember.ArrayController.create({
	content: [],

	topToBottom: function(){
		return this.get('content').toArray().reverse();
	}.property('content.@each'),

	_visibilityMode: 'selected',
	visibilityMode: function(key, value){
		if(arguments.length == 1){
			return this._visibilityMode;
		}

		if(this._isVisibilityMode(value)){
			this._visibilityMode = value;
			this._setVisiblities();
		}
	}.property().cacheable(false),

	_selectedLayer: null,
	selected: function(key, value){
		if(arguments.length == 1){
			return this.objectAt(this._selectedLayer);
		}

		this._selectedLayer = this.indexOf(value);
		this.forEach(function(item){
			item.set('selected', false);
		});
		value.set('selected', true);
		this._setVisiblities();
	}.property('content.@each.selected').cacheable(false),

	createLayer: function(layerArgs){
		var layersUrl = this.get('map.layers_url');
		$.ajax(layersUrl, {
			'contentType':'application/json',
			'context':this,
			'data': JSON.stringify(layerArgs),
			'type': 'put',
			'success': function(newLayer){
				console.log('new layer created', newLayer, arguments);
				var layerObj = RPGB.RestObject.create(newLayer);
				this.insertLayer(layerObj);
			}
		})
		console.log('create layer', arguments);
	},

	insertLayer: function(layerObj){
		if(! layerObj.get('next_layer_id')){
			this.pushObject(layerObj);
			return;
		}

		var insertBefore = 0;
		var findCb = function(item, index){
			if(item.get('id') == newLayer.next_layer_id){
				insertBefore = index;
				return true;
			}
			return false;
		};
		var found = this.find(findCb);
		if(found == null){
			this.reloadLayers();
			return;
		}
		this.insertAt(insertBefore, layerObj);
		return;
	},

	deleteSelectedLayer: function(){
		this.deleteLayer(this.get('selected'));
	},

	deleteLayer: function(layerObj){
		var url = layerObj.get('url');
		$.ajax(url, {
			'type':'delete',
			'context': this,
			'success': function(){
				this.removeObject(layerObj);
			}
		});
	},

	reloadLayers: function(){
		console.log('oh crap');
	},

	_isVisibilityMode: function(mode){
		var visiblityFunc = '_setVisibility_' + mode;
		return this[visiblityFunc];
	},

	_setVisiblities: function(){
		if(this._selectedLayer == null){
			return;
		}
		(this._isVisibilityMode(this._visibilityMode)).call(this);
	},

	_setVisibility_custom: function(){
		return;
	},

	_setVisibility_selected: function(){
		var selected = this._selectedLayer;
		this.forEach(function(item, index){
			if(index == selected){
				item.set('visibility', 'full');
				return;
			}
			item.set('visibility', 'none');
		});
	},

	_setVisibility_all_below: function(){
		var selected = this._selectedLayer;
		this.forEach(function(item, index){
			item.set('selected', index <= selected);
		});
	}
});

var mapJson = JSON.parse($('#mapJson').text());
var prop;
RPGB.mapController.lockCommits();
for(prop in mapJson){
	RPGB.mapController.set(prop, mapJson[prop]);
	RPGB.mapController.addRestfulProperty(prop);
}
mapJson.layers.map(function(layerData){
	var layerObj = RPGB.RestObject.create({});
	layerObj.lockCommits();
	layerObj.set('map', RPGB.mapController);
	var layerProp;
	layerObj.set('url', mapJson.layers_url + '/' + layerData.id);
	for(layerProp in layerData){
		layerObj.set(layerProp, layerData[layerProp]);
		layerObj.addRestfulProperty(layerProp);
	}
	RPGB.layerController.pushObject(layerObj);
	layerObj.unlockCommits();
});
RPGB.mapController.set('layers', RPGB.layerController);
RPGB.layerController.set('map', RPGB.mapController);
RPGB.mapController.unlockCommits();

RPGB.currentGridView = RPGB.GridPropertiesView.create({
	content: RPGB.mapController
});

RPGB.currentMapView = RPGB.MapView.create({
	content: RPGB.mapController
});

RPGB.layersToolbar = RPGB.LayerListView.create({
	content: RPGB.layerController
});

RPGB.currentGridView.appendTo('#toolbar');
RPGB.layersToolbar.appendTo('#toolbar');
RPGB.currentMapView.appendTo('#main');

</script>

{% endblock %}
{% comment %}
{# -*- vim: set ft=htmldjango: -- vim modeline -*- #}{% endcomment %}
