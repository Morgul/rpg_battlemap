{% extends "base.html" %}

{% block title %} - {{ map.name }} {% endblock %}

{% block page_style %}
<!--<link type="text/css" href="/contrib/css/smoothness/jquery-ui.css" rel="stylesheet" />-->
<link type="text/css" href="/contrib/bootstrap/css/bootstrap.css" rel="stylesheet" />
{% endblock %}
{% block content %}

<nav id="toolbar" class="btn-toolbar"></nav>

<script type="text/x-handlebars" data-template-name="map">
<svg
	xmlns="http://www.w3.org/2000/svg" version="1.1"
	{% templatetag openvariable %} bindStyle background-color="content.background_color" height="viewHeight"{% templatetag closevariable %}
	{% templatetag openvariable %}action "clicked" {% templatetag closevariable %}>
	{% templatetag openvariable %}action "didit" on="scroll"{% templatetag closevariable %}>
	<defs>
		<pattern x="0" y="0" width="512" height="512" id="gridPattern"
			patternUnits="userSpaceOnUse"
			{% templatetag openvariable %}bindXMLAttr patternTransform="transformString"{% templatetag closevariable %}>{% for patternInfo in pattern_helper %}
			<rect
				x="{{ patternInfo.x }}"
				y="{{ patternInfo.y }}"
				width="32" height="32" fill-opacity="0"
				{% templatetag openvariable %}bindAttr stroke="content.gridline_color"{% templatetag closevariable %}
				{% templatetag openvariable %} bindAttr stroke-width="content.gridline_width" {% templatetag closevariable %}
				{% templatetag openvariable %} bindAttr stroke-opacity="content.grid_opacity" {% templatetag closevariable %} />{% endfor %}
		</pattern>
	</defs>

	<rect x="0" y="0" width="100%" height="100%" stroke-opacity="0"
		fill="url(#gridPattern)" style="pointer-events:none;" id="gridRect"/>

	<g {% templatetag openvariable %}bindXMLAttr transform="transformString" {% templatetag closevariable %}>
	{% templatetag openvariable %}#each content.layers{% templatetag closevariable %}
		{% templatetag openvariable %}view RPGB.LayerItemSVGView tagName="g"{% templatetag closevariable %}
	{% templatetag openvariable %}/each{% templatetag closevariable %}

	{% templatetag openvariable %}view RPGB.EditPolyRegionView tagName="g"{% templatetag closevariable %}

	{% templatetag openvariable %}view RPGB.MapRulerView tagName="g"{% templatetag closevariable %}
	</g>

</svg>
</script>

{% endblock %}

{% block page_scripts %}

<script type="text/javascript" src="/contrib/jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="/contrib/bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="/contrib/handlebars-1.0.0.beta.6.js"></script>
<script type="text/javascript" src="/contrib/ember-1.0.pre.js"></script>
<script type="text/javascript" src="/js/bind_extensions.js"></script>
<script type="text/javascript" src="/js/rpgb_core.js"></script>
<script type="text/javascript" src="/js/rpgb_gridPropertiesView.js"></script>
<script type="text/javascript" src="/js/rpgb_mapView.js"></script>
<script type="text/javascript" src="/js/rpgb_layer_views.js"></script>
<script type="text/javascript" src="/js/rpgb_combatant_views.js"></script>
<script type="text/javascript" src="/js/rpgb_zone_views.js"></script>
<script id="mapJson" type="application/json">
{{ map_json }}
</script>
<script type="text/javascript">

/***
* code that does stuff
***/

RPGB.mapController = RPGB.RestObject.create({
	//clickedCell: null,
	//nearestCell: null,
	panX: 0,
	panY: 0,
	offsetX: 0,
	offsetY: 0,
	zoom: 1,

	_tool: {},
	currentTool: function(){
		if(this._tool){
			return this._tool.name;
		}
	}.property('tool'),
	tool: function(key, value){
		if(arguments.length == 1){
			return this._tool;
		}
		if(this._tool.teardown){
			this._tool.teardown();
		}
		this._tool = arguments[1];
		return this._tool;
	}.property(),

	adjustZoom: function(delta){
		var oldZoom = this.get('zoom');
		var newZoom = oldZoom + delta;
		if(newZoom < 0.1){
			newZoom = 0.1;
		} else if(newZoom > 3){
			newZoom = 3;
		}
		this.set('zoom', newZoom);
	},

	panEvent: function(dx, dy){
		var pannedX = this.get('panX');
		var pannedY = this.get('panY');
		this.set('panX', pannedX + dx);
		this.set('panY', pannedY + dy);
	},

	pixelsToCell: function(x,y){
		var cellx = this.dimensionToCell(x, this.get('panX'), this.get('offsetX'));
		var celly = this.dimensionToCell(y, this.get('panY'), this.get('offsetY'));
		return [cellx, celly];
	},

	toolDispatch: function(eventName, originalEvent){
		var tool = this.get('tool');
		var xy = this.pixelsToCell(originalEvent.pageX, originalEvent.pageY);
		if(tool && tool[eventName]){
			return tool[eventName](xy[0], xy[1], originalEvent, this);
		}
	},

	dimensionToCell: function(d, pan, offset){
		var cell = RPGB.CELL_SIZE;
		return ( (d - pan - offset) / this.get('zoom') ) / cell
	},

	dimensionToPixel: function(d){
		return d * RPGB.CELL_SIZE;
	},

	cellToPixels: function(x, y){
		var cellx = this.dimensionToPixel(x, this.get('panX'));
		var celly = this.dimensionToPixel(y, this.get('panY'));
		return [cellx, celly];
	}

});
RPGB.layerController = Ember.ArrayController.create({
	content: [],

	topToBottom: function(){
		return this.get('content').toArray().reverse();
	}.property('content.@each'),

	_visibilityMode: 'selected',
	visibilityMode: function(key, value){
		if(arguments.length == 1){
			return this._visibilityMode;
		}

		if(this._isVisibilityMode(value)){
			this._visibilityMode = value;
			this._setVisiblities();
		}
	}.property().cacheable(false),

	_selectedLayer: null,
	selected: function(key, value){
		if(arguments.length == 1){
			return this.objectAt(this._selectedLayer);
		}

		this._selectedLayer = this.indexOf(value);
		this.forEach(function(item){
			item.set('selected', false);
		});
		value.set('selected', true);
		this._setVisiblities();
	}.property('content.@each.selected').cacheable(false),

	createLayer: function(layerArgs){
		var layersUrl = this.get('map.layers_url');
		$.ajax(layersUrl, {
			'contentType':'application/json',
			'context':this,
			'data': JSON.stringify(layerArgs),
			'type': 'put',
			'success': function(newLayer){
				var layerObj = RPGB.RestObject.create(newLayer);
				this.insertLayer(layerObj);
			}
		})
	},

	insertLayer: function(layerObj){
		if(! layerObj.get('next_layer_id')){
			this.pushObject(layerObj);
			return;
		}

		var insertBefore = 0;
		var findCb = function(item, index){
			if(item.get('id') == newLayer.next_layer_id){
				insertBefore = index;
				return true;
			}
			return false;
		};
		var found = this.find(findCb);
		if(found == null){
			this.reloadLayers();
			return;
		}
		this.insertAt(insertBefore, layerObj);
		return;
	},

	deleteSelectedLayer: function(){
		this.deleteLayer(this.get('selected'));
	},

	deleteLayer: function(layerObj){
		var url = layerObj.get('url');
		$.ajax(url, {
			'type':'delete',
			'context': this,
			'success': function(){
				this.removeObject(layerObj);
			}
		});
	},

	reloadLayers: function(){
		console.log('reload layers nyi');
	},

	_isVisibilityMode: function(mode){
		var visiblityFunc = '_setVisibility_' + mode;
		return this[visiblityFunc];
	},

	_setVisiblities: function(){
		if(this._selectedLayer == null){
			return;
		}
		(this._isVisibilityMode(this._visibilityMode)).call(this);
	},

	_setVisibility_custom: function(){
		return;
	},

	_setVisibility_selected: function(){
		var selected = this._selectedLayer;
		this.forEach(function(item, index){
			if(index == selected){
				item.set('visibility', 'full');
				return;
			}
			item.set('visibility', 'none');
		});
	},

	_setVisibility_all_below: function(){
		var selected = this._selectedLayer;
		this.forEach(function(item, index){
			item.set('selected', index <= selected);
		});
	}
});
RPGB.combatantController = Ember.ArrayController.create({
	content: [],
	newCombatant: Ember.Object.create({
		name: 'Fight Man',
		aura_size: 0,
		aura_color: 'white'
	}),
	nameStash: {},

	_selectedCombatant: null,
	selected: function(key, value){
		if(arguments.length == 1){
			return this.objectAt(this._selectedCombatant);
		}

		this._selectedCombatant = this.indexOf(value);
		this.forEach(function(item){
			item.set('selected', false);
		});
		value.set('selected', true);
	}.property('content.@each.selected').cacheable(false),

	createCombatant: function(combatantArgs){
		var combatantsUrl = this.get('map.combatants_url');
		$.ajax(combatantsUrl, {
			'contentType':'application/json',
			'context':this,
			'data':JSON.stringify(combatantArgs),
			'type':'put',
			'success': function(newCombatant){
				var combatantObj = RPGB.RestObject.create(newCombatant);
				this.insertCombatant(combatantObj);
				this.buildNameStash();
			}
		});
	},

	insertCombatant: function(combatantObj){
		if(! combatantObj.get('next_combatant_id')){
			this.pushObject(combatantObj);
			return;
		}

		var insertBefore = 0;
		var nextId = combatantObj.get('next_combatant_id');
		var findCb = function(item, index){
			if(item.get('id') == nextId){
				insertBefore = index;
				return true;
			}
			return false;
		}
		var found = this.find(findCb);
		if(found == null){
			this.reloadCombatants();
			return;
		}
		this.insertAt(insertBefore, combatantObj);
		return;
	},

	deleteSelectedCombatant: function(){
		this.deleteCombatant(this.get('selected'));
	},

	deleteCombatant: function(combatantObj){
		var url = combatantObj.get('url');
		$.ajax(url, {
			'type':'delete',
			'context': this,
			'success': function(){
				this.removeObject(combatantObj);
				this.buildNameStash();
			}
		});
	},

	reloadCombatants: function(){
		console.log('reload combatants nyi');
	},

	buildNameStash: function(){
		this.nameStash = {};
		var thisRef = this;
		var regEx = /(.*) (\d+)$/;
		this.forEach(function(item){
			var name = item.get('name');
			var match = name.match(regEx);
			if(match == null){
				if(thisRef.nameStash[name]){
					thisRef.nameStash[name] += 1;
					return;
				}
				thisRef.nameStash[name] = 1;
				return;
			}
			var nameNum = parseInt(match[2]);
			var name = match[1];
			if(thisRef.nameStash[name] < nameNum){
				thisRef.nameStash[name] = nameNum;
			}
		});
	},

	nextName: function(name){
		if(this.nameStash[name]){
			return name + ' ' + (this.nameStash[name] + 1);
		}
		return name
	}
});

RPGB.rulerController = Ember.Object.create({
	start: null,
	end: null,
	map: RPGB.mapController,

	length: function(){
		var start = this.get('start');
		var end = this.get('end');
		if(start && end){
			var deltax = Math.abs( start.x - end.x );
			var deltay = Math.abs( start.y - end.y );
			if(deltax > deltay){
				return deltax;
			}
			return deltay
		}
		return 0
	}.property('start', 'end').cacheable(false),

	isMeasuring: function(){
		var start = this.get('start');
		var end = this.get('end');
		if(start && end){
			return true;
		}
		return false;
	}.property('start', 'end')
});
RPGB.mapController.set('ruler', RPGB.rulerController);

var mapJson = JSON.parse($('#mapJson').text());
var prop;
RPGB.mapController.lockCommits();
for(prop in mapJson){
	RPGB.mapController.set(prop, mapJson[prop]);
	RPGB.mapController.addRestfulProperty(prop);
}
mapJson.layers.map(function(layerData){
	var layerObj = RPGB.RestObject.create({
		combatants: function(){
			var thisId = this.get('id');
			return this.get('map.combatants').filter(function(item){
				return item.get('layer_id') == thisId;
			});
		}.property('map.combatants.@each.layer_id'),
		_selectedType: null,
		_selectedIndex: null,
		selectedZoneAura: function(key, value){
			var auraController = this.get('auras');
			var zoneController = this.get('zones');
			if(arguments.length == 1){
				if(this._selectedType == 'zone'){
					return zoneController.objectAt(this._selectedIndex);
				} else if(this._selectedType == 'aura'){
					return auraController.objectAt(this._selectedIndex);
				}
				return null;
			}
			auraController.forEach(function(item){
				item.set('selected', false);
			});
			zoneController.forEach(function(item){
				item.set('selected', false);
			});
			if(! value){
				this._selectedIndex = null;
				this._selectedType = null;
				return null;
			}
			var type = value.get('type');
			if(type == 'zone'){
				this._selectedIndex = zoneController.indexOf(value);
			} else {
				this._selectedIndex = auraController.indexOf(value);
			}
			if(this._selectedIndex == undefined || this._selectedIndex == null){
				this._selectedIndex = null;
				this._selectedType = null;
				return null;
			}
			this._selectedType = type;
			value.set('selected', true);
			return value;
		}.property('auraController.content.@each.selected', 'zoneController.content.@each.selected').cacheable(false),

		createZoneAura: function(zoneOrAura, type, name){
			var url = this.get('url');
			url += '/' + zoneOrAura + 's';
			$.ajax(url, {
				'contentType':'application/json',
				'context':this,
				'data': JSON.stringify({
					'name': name,
					'element_type': type
				}),
				'type':'put',
				'success': function(newZoneOrAura){
					var zaObj = RPGB.RestObject.create(newZoneOrAura);
					if(zoneOrAura == 'zone'){
						this.get('zones').pushObject(zaObj);
					} else {
						this.get('auras').pushObject(zaObj);
					}
				}
			});
		},

		deleteSelected: function(){
			var zoneAura = this.get('selectedZoneAura');
			if(zoneAura){
				this.deleteZoneAura(zoneAura);
			}
		},

		deleteZoneAura: function(obj){
			var url = obj.get('url');
			$.ajax(url, {
				'type':'delete',
				'context': this,
				'success': function(){
					if(obj.get('type') == "aura"){
						this.get('auras').removeObject(obj);
					}
					this.get('zones').removeObject(obj);
				}
			});
		}
	});
	layerObj.lockCommits();
	layerObj.set('map', RPGB.mapController);
	var layerProp;
	layerObj.set('url', mapJson.layers_url + '/' + layerData.id);
	for(layerProp in layerData){
		layerObj.set(layerProp, layerData[layerProp]);
		layerObj.addRestfulProperty(layerProp);
	}
	var mapFun = function(elem){
		var restObj = RPGB.RestObject.create({});
		restObj.lockCommits();
		var elemProp;
		for(elemProp in elem){
			restObj.set(elemProp, elem[elemProp]);
			restObj.addRestfulProperty(elemProp);
		}
		restObj.removeRestfulProperty('url');
		restObj.unlockCommits();
		return restObj;
	};
	var auraController = Ember.ArrayController.create({
		content: []
	});
	layerData.auras.map(function(auraData){
		var auraObj = mapFun(auraData);
		auraObj.set('type', 'aura');
		auraController.pushObject(auraObj);
		return auraObj;
	});
	layerObj.set('auras', auraController);
	var zoneController = Ember.ArrayController.create({
		content: []
	});
	layerData.zones.map(function(zoneData){
		var zoneObj = mapFun(zoneData);
		zoneObj.set('type', 'zone');
		zoneController.pushObject(zoneObj);
		return zoneObj;
	});
	layerObj.set('zones', zoneController);
	RPGB.layerController.pushObject(layerObj);
	layerObj.unlockCommits();
});
mapJson.combatants.map(function(combatantData){
	var combatantObj = RPGB.RestObject.create({});
	combatantObj.lockCommits();
	combatantObj.set('map', RPGB.mapController);
	var combatantProp;
	combatantObj.set('url', mapJson.combatants_url + '/' + combatantData.id);
	for(combatantProp in combatantData){
		combatantObj.set(combatantProp, combatantData[combatantProp]);
		combatantObj.addRestfulProperty(combatantProp);
	}
	combatantObj.addRestfulProperty('next_combatant_id');
	combatantObj.addRestfulProperty('layer_id');
	// TODO remove this once debugging/dev is done.
	combatantObj.addRestfulProperty('token_image');
	RPGB.combatantController.pushObject(combatantObj);
	combatantObj.unlockCommits();
})
RPGB.mapController.set('layers', RPGB.layerController);
RPGB.mapController.set('combatants', RPGB.combatantController);
RPGB.layerController.set('map', RPGB.mapController);
RPGB.combatantController.set('map', RPGB.mapController);
RPGB.editRegionController = Ember.Object.create({
	layers: RPGB.layerController,
	map: RPGB.mapController,
	points: Ember.ArrayController.create({content:[]}),
	_selectedPoint: -1,
	_suppressPushPoints: 0,
	_suppressUpdatePoints: 0,

	isEditing: function(){
		/*if(this.get('map.tool.name') != 'Edit Region'){
			return false;
		}*/
		if(this.get('layers.selected.selectedZoneAura')){
			return true;
		}
		return false;
	}.property('map.tool.name', 'layers.selected.selectedZoneAura'),

	selectedPoint: function(key, value){
		if(arguments.length > 1){
			this.get('points').forEach(function(item){
				item.set('selected', false);
			});
			this._selectedPoint = this.get('points').indexOf(value);
			if(this._selectedPoint > -1){
				value.set('selected', true);
			}
			return value;
		}
		if(this._selectedPoint > -1){
			return this.get('points').objectAt(this._selectedPoint);
		}
	}.property('points.@each.selected'),

	pushPoints: function(){
		if(this._suppressPushPoints){
			return;
		}
		var zoneAura = this.get('layers.selected.selectedZoneAura');
		if(! zoneAura){
			return;
		}
		var pointStrArr = this.get('points').map(function(point){
			if(! point){
				return '';
			}
			var x = point.get('x');
			var y = point.get('y');
			return x + ' ' + y;
		});
		var points = pointStrArr.join(' ');
		zoneAura.set('element_attrs.points', points);
	}.observes('points.content.length', 'points.@each.x', 'points.@each.y'),

	updatePoints: function(){
		if(this._suppressUpdatePoints){
			return;
		}
		var regionpoints = this.get('layers.selected.selectedZoneAura.element_attrs.points');
		var points = Ember.ArrayController.create({content:[]});
		if(! regionpoints){
			this.set('points', points);
			return;
		}
		var elem = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
		elem.setAttribute('points', regionpoints);
		var mapFun = function(point){
			var pointObj = Ember.Object.create({
				x: point.x,
				y: point.y
			});
			return pointObj;
		}
		for(var i = 0; i < elem.animatedPoints.numberOfItems; i++){
			var point = elem.animatedPoints.getItem(i);
			points.pushObject(mapFun(point));
		}
		this.set('points', points);
	}.observes('layers.selected.selectedZoneAura')
});
RPGB.mapController.set('regionEditor', RPGB.editRegionController);
RPGB.toolController = Ember.Object.create({
	'layers': RPGB.layerController,
	'combatants': RPGB.combatantController,
	'map': RPGB.mapController,
	'ruler': RPGB.rulerController,
	'editRegion': RPGB.editRegionController,

	init: function(){
		this.setToolToPanMap();
	},

	setToolToPanMap: function(){
		this.set('map.tool', this.makePanTool());
	},

	setToolToRuler: function(){
		this.set('map.tool', this.makeRulerTool());
	},

	setToolToMoveCombatant: function(){
		this.set('map.tool', this.makeMoveCombatantTool());
	},

	setToolToRuler: function(){
		this.set('map.tool', this.makeRulerTool());
	},

	setToolToAddCombatant: function(){
		this.set('map.tool', this.makeAddCombatantTool());
	},

	setToolToEditZone: function(){
		this.set('map.tool', this.makeEditRegionTool());
	},

	setToolToDeletePoints: function(){
		this.set('map.tool', this.makeDeletePointsTool());
	},

	makeDeletePointsTool: function(){
		var ed = this.get('editRegion');
		var mouseup = function(){
			var selected = ed.get('selectedPoint');
			if(! selected){
				return;
			}
			ed.set('selecedPoint', null);
			ed.get('points.content').removeObject(selected);
			ed.get('layers.selected.selectedZoneAura').commitProperties('element_attrs');
		};

		return {
			'name': 'Delete Points',
			'mouseup': mouseup
		}
	},

	makeEditRegionTool: function(){
		var ed = this.get('editRegion');
		var isDown = false;

		var mousedown = function(){
			isDown = true;
		};

		var mouseup = function(x, y){
			var selected = ed.get('selectedPoint');
			if(! selected){
				x = Math.round(x * 2) / 2;
				y = Math.round(y * 2) / 2;
				var selected = Ember.Object.create({
					'x': x,
					'y': y
				});
				var points = ed.get('points');
				points.pushObject(selected);
			}
			ed.set('selectedPoint', null);
			ed.get('layers.selected.selectedZoneAura').commitProperties('element_attrs');
			isDown = false;
		};

		var mousemove = function(x, y){
			if(! isDown){
				return;
			}
			var selected = ed.get('selectedPoint');
			x = Math.round(x * 2) / 2;
			y = Math.round(y * 2) / 2;

			if(! selected){
				var selected = Ember.Object.create({
					'x': x,
					'y': y
				});
				var points = ed.get('points');
				points.pushObject(selected);
				ed.set('selectedPoint', selected);
			}
			selected.set('x', x);
			selected.set('y', y);
		};

		return {
			'name':'Edit Region',
			'mousedown': mousedown,
			'mousemove': mousemove,
			'mouseup': mouseup
		};
	},

	makeAddCombatantTool: function(){
		var combatantsController = this.get('combatants');
		var layersController = this.get('layers');

		var click = function(x, y){
			var combatantBase = combatantsController.get('newCombatant');
			var combatantArgs = {
				name: combatantsController.nextName(combatantBase.get('name')),
				size: combatantBase.get('size'),
				color: combatantBase.get('color'),
				aura_size: combatantBase.get('aura_size'),
				aura_color: combatantBase.get('aura_color'),
				x: Math.floor(x),
				y: Math.floor(y)
			};
			var selectedLayer = layersController.get('selected');
			if(selectedLayer != null){
				combatantArgs.layer_id = selectedLayer.get('id');
			}
			combatantsController.createCombatant(combatantArgs);
		};

		return {
			'name': 'Add Combatant',
			'click': click
		};
	},

	makeMoveCombatantTool: function(){
		var dragData = {
			offsetX: 0,
			offsetY: 0
		};
		var moving = false;
		var selectedCombatant = this.get('combatants.selected');
		var combatantsController = this.get('combatants');

		var moveCombatant = function(x,y){
			selectedCombatant.set('x', Math.floor(x) - dragData.offsetX);
			selectedCombatant.set('y', Math.floor(y) - dragData.offsetY);
		};

		var mousedown = function(x, y, event, map){
			selectedCombatant = combatantsController.get('selected');
			moving = true;
			selectedCombatant.lockCommits();
			if(event.srcElement.nodeName == 'svg'){
				dragData.offsetX = 0;
				dragData.offsetY = 0;
			} else {
				dragData.offsetX = Math.floor(x) - selectedCombatant.get('x');
				dragData.offsetY = Math.floor(y) - selectedCombatant.get('y');
			}
			moveCombatant(x,y);
		};

		var mouseup = function(x, y, event, map){
			moving = false;
			selectedCombatant.unlockCommits();
			selectedCombatant.commitProperties('x', 'y');
		};

		var mousemove = function(x, y){
			if(! moving){
				return;
			}
			moveCombatant(x,y);
		};

		var mouseleave = function(){
			moving = false;
			selectedCombatant.unlockCommits();
		}

		return {
			'name': 'Move Combatant',
			'mousedown': mousedown,
			'mouseup': mouseup,
			'mousemove': mousemove,
			'mouseleave': mouseleave
		}
	},

	makePanTool: function(){
		var dragData = {
			lastX: 0,
			lastY: 0
		};
		var panning = false;

		var mousedown = function(_x, _y, event, map){
			panning = true;
			dragData.lastX = event.pageX;
			dragData.lastY = event.pageY;
			return false;
		};
		var mouseup = function(_x, _y, event, map){
			panning = false;
			return false;
		};
		var mousemove = function(_x, _y, event, map){
			if(! panning){
				return;
			}
			var deltaX = event.pageX - dragData.lastX;
			var deltaY = event.pageY - dragData.lastY;
			dragData.lastX = event.pageX;
			dragData.lastY = event.pageY;
			map.panEvent(deltaX, deltaY);
		};
		var mouseleave = function(_x, _y, event, _map){
			if(event.srcElement.nodeName == "svg"){
				panning = false;
			}
		};

		return {
			'name': 'Pan Map',
			'mousedown': mousedown,
			'mouseup': mouseup,
			'mousemove': mousemove,
			'mouseleave': mouseleave
		};
	},

	makeRulerTool: function(){
		var ruler = this.get('ruler');
		// stats
		// no_measure_up -> measure_down
		// measuere_down -> measure_up | measure_down
		var downx;
		var downy;
		var moveAction = 'none';

		var mousedown = function(x, y){
			if(moveAction == 'measure'){
				ruler.set('start', null);
				ruler.set('end', null);
				moveAction = 'none';
				return;
			}
			downx = Math.floor(x);
			downy = Math.floor(y);
			var xy = {x: downx, y: downy};
			moveAction = 'measure';
			ruler.set('start', xy);
		};
		var mousemove = function(x, y){
			if(moveAction == 'none'){
				return;
			}
			ruler.set('end', {x: Math.floor(x), y: Math.floor(y)});
		};
		var teardown = function(){
			ruler.set('start', null);
			ruler.set('end', null);
		};
		return {
			'name': 'Measure',
			'mousedown': mousedown,
			'mousemove': mousemove,
			'teardown': teardown
		}
	}
});

RPGB.mapController.unlockCommits();

RPGB.currentGridView = RPGB.GridPropertiesView.create({
	content: RPGB.mapController
});

RPGB.currentMapView = RPGB.MapView.create({
	content: RPGB.mapController
});

RPGB.layersToolbar = RPGB.LayerListView.create({
	content: RPGB.layerController
});

RPGB.zoneAuraToolbar = RPGB.ZoneAuraListView.create({
	content: RPGB.layerController
});

RPGB.combatantsToolbar = RPGB.CombatantListView.create({
	content: RPGB.combatantController
});

RPGB.selectedCombatantToolbar = RPGB.CombatantDropDown.create({
	content: RPGB.combatantController
});

RPGB.selectedZoneAuraToolbar = RPGB.ZoneAuraDropDown.create({
	layers: RPGB.layerController,
	content: function(){
		return this.get('layers.selected.selectedZoneAura');
	}.property('layers.selected.selectedZoneAura')
});

RPGB.mapToolbar = RPGB.MapToolbar.create({
	content: RPGB.toolController
});

RPGB.mapToolbar.appendTo('#toolbar');
RPGB.currentGridView.appendTo('#toolbar');
RPGB.layersToolbar.appendTo('#toolbar');
RPGB.zoneAuraToolbar.appendTo('#toolbar');
RPGB.selectedZoneAuraToolbar.appendTo('#toolbar');
RPGB.combatantsToolbar.appendTo('#toolbar');
RPGB.selectedCombatantToolbar.appendTo('#toolbar');
RPGB.currentMapView.appendTo('#main');

</script>

{% endblock %}
{% comment %}
{# -*- vim: set ft=htmldjango: -- vim modeline -*- #}{% endcomment %}
